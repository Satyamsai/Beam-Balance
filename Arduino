#include <Servo.h>
Servo servo;
int sp=9;
int trigPin = 11;    // Trigger
int echoPin = 12;    // Echo
long duration, cm, inches;
int lastcm=24;
int pos=72;


double kp=4;
double ki=0;
double kd=800;
double error=0;
double Setpoint=23;
unsigned long currentTime, previousTime;
double elapsedTime;
double cumError, rateError;
 double lastError;



 
void setup() {
 
  Serial.begin (9600);
  
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
  servo.attach(sp);
}
 
void loop() {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(5);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);
 
 
  pinMode(echoPin, INPUT);
  duration = pulseIn(echoPin, HIGH);
 
 
  cm = (duration/2) / 29;     
  
  
 
  int disp=lastcm-cm;
  if(disp<0)
  disp=-disp;
  if(cm>45)
  cm=24;
  Serial.print(cm);
  Serial.print(" cm ");
if(disp<10)
  {

 
  double pid=computePID((double)cm);
  int d=constrain(cm,4,60);
 /* if(d<24)
  pos=map(d,4,24,60,74);
  else if(d>33)
  pos=map(d,33,58,76,82);
  else
  pos=75;.
  servo.write(pos);
  Serial.print(pos);
    Serial.println();
    delay(50);
    
  }*/
  
  pid=(int)pid;
  
  pid=map(pid,-110,110,40,120);
 
Serial.println(pid);
mservo.write(pid);
}
lastcm=cm;
}
double computePID(double inp){     
        currentTime = millis();                
        elapsedTime = (double)(currentTime - previousTime);       
        
        error = Setpoint - inp;                                
                       
        rateError = (error - lastError)/elapsedTime;   
 
        double out = kp*error + ki*cumError + kd*rateError;                 
 
        lastError = error;                                
 // out=constrain(out,-25,25);
         Serial.println(out);
    
        return out;
